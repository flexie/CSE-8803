<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Exercise 3: wavefield extrapolation and migration - Imaging w/ data-driven models</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Imaging w/ data-driven models</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../outline/" class="nav-link">Topics</a>
                            </li>
                            <li class="navitem">
                                <a href="../../homework/" class="nav-link">Assigments</a>
                            </li>
                            <li class="navitem">
                                <a href="../../project/" class="nav-link">Projects</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#exercise-3-wavefield-extrapolation-and-migration" class="nav-link">Exercise 3: wavefield extrapolation and migration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#f-k-domain-transform-function-fktran" class="nav-link">f-k domain transform function fktran</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#questions" class="nav-link">Questions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#zero-offset-migration" class="nav-link">Zero-offset migration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#questions_1" class="nav-link">Questions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#prestack-migration" class="nav-link">Prestack migration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#question" class="nav-link">Question</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#questions_2" class="nav-link">Questions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="exercise-3-wavefield-extrapolation-and-migration">Exercise 3: wavefield extrapolation and migration</h1>
<p>Contents:
 - Wavefield extrapolation
 - Zero-offset migration
 - Prestack migration
 - Wavefield extrapolation</p>
<p>For a constant-velocity medium, we can extrapolate a wavefield at depth $z$ to depth $z+\Delta z$ via a simple phase shift in the $f-k$ domain:</p>
<p>$ u(\omega,k,z + \Delta z) = u(\omega,k,z)\exp[\imath\Delta z\sqrt(\omega^2/v^2 - k^2)]$</p>
<p>To illustrate this, we generate a source wavefield in the $t-x$ domain and extrapolate it. First, let's define an impulsive source.</p>
<pre><code class="language-julia">using PyPlot
</code></pre>
<h1 id="f-k-domain-transform-function-fktran">f-k domain transform function fktran</h1>
<pre><code class="language-julia">function fktran(a,t,x,mode)
    &quot;&quot;&quot;
    f-k transform for real-values input.

    use:
        b, f, k = fktran(a,t,x,mode)

    input:
        a - matrix in t-x domain (nt x nx)
        t - time vector
        x - x vector
        mode - 1:forward, -1:inverse
    &quot;&quot;&quot;

    nt = length(t)
    nx = length(x)

    dt = t[2]-t[1]
    dx = x[2] - x[1]

    xmax = x[end] - x[1]
    tmax = t[end] - t[1]


    f = 0:1/tmax:.5/dt
    k = -.5/dx:1/xmax:.5/dx

    nf = length(f)
    if mode == 1
        b = fft(a, 1)
        b = b[1:nf, :]
        b = ifft(b, 2)
        b = circshift(b,[0 ceil(Int, nx/2)-1]);
    elseif mode == -1
        b = circshift(a,[0 floor(Int, nx/2)+1]);
        b = fft(b, 2)
        b = ifft(b, 1)
        b = real(b)
    else
        error(&quot;unknown mode&quot;)
    end
    return b, f, k
end
</code></pre>
<pre><code>fktran (generic function with 1 method)
</code></pre>
<pre><code class="language-julia"># time coordinate in seconds as column vector
t = 0:.004:1;

# spatial coordinate in meters as row vector
x = 0:10:1000;

# generate 2D grid:
tt = [ti for ti in t, xi in x];
xx = [xi for ti in t, xi in x];
</code></pre>
<pre><code class="language-julia"># Source wavefield is impulsive source at t=0.1 and x=500,
source = (tt-.1).*exp.(-1e-3*(xx.-500).^2 .- 1e3*(tt-.1).^2);
</code></pre>
<pre><code class="language-julia"># plot it
imshow(source, cmap=&quot;Greys&quot;, extent=[x[1], x[end], t[end], t[1]], aspect=500)
xlabel(&quot;x [m]&quot;)
ylabel(&quot;t [s]&quot;)
title(&quot;wavefield at z=0 m.&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise3_6_0.png" /></p>
<pre><code>PyObject Text(0.5,1,'wavefield at z=0 m.')
</code></pre>
<pre><code class="language-julia"># now, transform it to the f-k domain using fktran
source_fk, f, k = fktran(source,t,x,1);
</code></pre>
<p>Next, we define the extrapolation factor and plot it.</p>
<pre><code class="language-julia"># generate a grid for f,k
ff = [fi for fi in f, ki in k]
kk = [ki for fi in f, ki in k]

# the extrapolation factor for a velocity v is defined as follows
# (note the factor \(2 pi\) to go from frequency to wavenumber)
v  = 2000
dz = 10
kz = 2*pi*sqrt.(complex.((ff./v).^2 - kk.^2))

W  = exp.(dz*im.*kz)

# now plot absolute value for 10 Hz
plot(k,abs.(W[ff.==10]))
xlabel(&quot;k [1/m]&quot;);ylabel(&quot;|W|&quot;);title(&quot;|W| @ 10 Hz.&quot;);
</code></pre>
<p><img alt="png" src="../../img/Exercise3_9_0.png" /></p>
<p>The region where the extrapolation factor is smaller than one is called the evanescent region. Waves this these wavenumbers will be damped. We have to be carefull with the sign of (k_z) in the exponentional factor and make sure that the absolute value is always smaller than one.</p>
<p>The wavefield at z = 500 m looks like</p>
<pre><code class="language-julia"># fix sign of kz
kz = -real(kz)+im*abs.(imag(kz));
W  = exp.(500*im.*kz);

# extrapolate and transform back to t-x
source_extrap, _, _ = fktran(W.*source_fk,t,x,-1);

#plot
imshow(real(source_extrap), cmap=&quot;Greys&quot;, vmin=-.1e-2, vmax=.1e-2, extent=[x[1], x[end], t[end], t[1]], aspect=700)
xlabel(&quot;x [m]&quot;)
ylabel(&quot;t [s]&quot;)
title(&quot;wavefield at z=500 m.&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise3_11_0.png" /></p>
<pre><code>PyObject Text(0.5,1,'wavefield at z=500 m.')
</code></pre>
<h1 id="questions">Questions</h1>
<ul>
<li>What happens if the imaginary part of kz has the wrong sign? try it.</li>
<li>same for the real part.</li>
<li>What does the extrapolator look like in the t-x domain?</li>
<li>How can you extraplotate the wavefield in the t-x domain directly using the extrapolator in the t-x domain?</li>
</ul>
<h1 id="zero-offset-migration">Zero-offset migration</h1>
<p>In this part of the exercise we look at zero-offset migration. This type of migration is based on the
"exploding-reflector" concept. Zero-offset migration can be done by exptrapolating the zero-offset data with half-velocity
and taking the image to be slice of the wavefield at $t=0$ for each depth step: $I(z,x) = u(z,x,t=0)$</p>
<p>The function wave_extrap.m takes in a wavefield u and the correspoding time/space vectors t,x, a velocity v,
a depth step dz and a propagation direction dir and extrapolates the input wavefield.</p>
<p>Load the zero-offset <code>data data1_zero.segy</code> (in Dropbox) and define the source, receiver and time coordinates. The units of the source and receiver coordinates are in meters for this file. The data looks like this</p>
<pre><code class="language-julia">using SeisIO

# Dowload and adapt path
shot = segy_read(&quot;data_zo.segy&quot;)

shot_data = Float32.(shot.data)

sx = get_header(shot, &quot;SourceX&quot;, scale=false)
dt = get_header(shot, &quot;dt&quot;)[1]/1e6
nt = get_header(shot, &quot;ns&quot;)[1]
T = 0:dt:(nt -1)*dt
</code></pre>
<pre><code>[1m[33mWARNING: [39m[22m[33mFixed length trace flag set in stream: IOBuffer(data=UInt8[...], readable=true, writable=false, seekable=true, append=false, size=253644, maxsize=Inf, ptr=3601, mark=-1)[39m





0.0:0.004:1.0
</code></pre>
<pre><code class="language-julia">imshow(shot_data, vmin=-.1, vmax=.1, cmap=&quot;Greys&quot;, extent=[sx[1], sx[end], T[end], T[1]], aspect=1000)
xlabel(&quot;source position [m]&quot;)
ylabel(&quot;t [s]&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise3_16_0.png" /></p>
<pre><code>PyObject Text(24,0.5,'t [s]')
</code></pre>
<p>Use the function <code>wave_extrap</code> to migrate the zero offset section. A reasonable depth axis is z = 0:5:1000. Use the source position as lateral position x. The correct velocity is v0 = 2000 km/s (but, remember this is zero-offset migration so adapt the velocity accordingly!). A zero-offset migration can done as follows:</p>
<pre><code class="language-julia">function wave_extrap(u,t,x,v,dz,dir)
# wavefield extrapolation by phase shift
#
# use:
#   v = wave_extrap(u,t,x,v,dz,dir)
#
# input:
#   u   - wavefield as matrix of size length(t) x length(x)
#   t   - time coordinates in seconds as column vector
#   x   - space coordinates in meters as row vector
#   v   - velocity in m/s (scalar)   
#   dz  - depth step in meters
#   dir - 1: forward in time, -1 backward in time
#
# output:
#   v   - extrapolated wavefield
#

    # fk transform of the wavefield
    spec, f, k = fktran(u, t, x, 1)

    # define grid and kz
    ff = [fi for fi in f, ki in k]
    kk = [ki for fi in f, ki in k]
    kz = 2*pi*sqrt.(complex((ff/v).^2-kk.^2))

    # set sign of real part of kz
    kz = -sign.(dir)*real(kz)+im*abs.(imag(kz))

    # apply phase shift
    spec = exp.(im*abs.(dz).*kz).*spec

    # inverse fk transform
    v, _, _  = fktran(spec, f, k, -1)

    # take real part of wavefield
    v = real(v)

    return v
end
</code></pre>
<pre><code>wave_extrap (generic function with 1 method)
</code></pre>
<pre><code class="language-julia"># depth axis
z  = 0:5:1000
dz = 5

# velocity
v = 2000

# migrate for correct velocity
migcorr = zeros(length(z),length(sx))
for k = 1:length(z)
    tmp = wave_extrap(shot_data, T, sx, v./2, z[k], -1)
    migcorr[k, :] =  tmp[1, :]
end

</code></pre>
<pre><code class="language-julia"># plot it
imshow(migcorr, cmap=&quot;Greys&quot;, vmin=-.1, vmax=.1, extent=[sx[1], sx[end], z[end], z[1]], aspect=1)
xlabel(&quot;x [m]&quot;)
ylabel(&quot;z [m]&quot;)
title(&quot;correct velocity&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise3_20_0.png" /></p>
<pre><code>PyObject Text(0.5,1,'correct velocity')
</code></pre>
<h1 id="questions_1">Questions</h1>
<ul>
<li>Compare the migrated result to the zero-offset section. What do you notice? For easier comparison, you might want to transform the time axis into depth using the correct velocity.</li>
<li>Do a zero-offset migration for too low and too high velocities. What do you notice?</li>
<li>Repeat the same exercise for data2_zo.su. What do you notice here?</li>
</ul>
<h1 id="prestack-migration">Prestack migration</h1>
<p>We can also create an image by extrapolating the source wavefields and the data and correlating them at different depth levels.</p>
<p>Read the data <code>data_ex3.segy</code> (in Dropbox)</p>
<pre><code class="language-julia">block = segy_read(&quot;data_ex3.segy&quot;)

sx = get_header(block, &quot;SourceX&quot;, scale=false)
rx = get_header(block, &quot;GroupX&quot;, scale=false)
dt = get_header(block, &quot;dt&quot;)[1]/1e6
nt = get_header(block, &quot;ns&quot;)[1]
T = 0:dt:(nt -1)*dt

# unique src/rec locations

xs = unique(sx)
xr = unique(rx);
</code></pre>
<pre><code>[1m[33mWARNING: [39m[22m[33mFixed length trace flag set in stream: IOBuffer(data=UInt8[...], readable=true, writable=false, seekable=true, append=false, size=1385684, maxsize=Inf, ptr=3601, mark=-1)[39m
</code></pre>
<p>We extrapolate both source and receiver wavefields for one shot using <code>wave_extrap</code> (see comments in wave_extrap for documenation) and plot them side-by-side:</p>
<pre><code class="language-julia"># velocity
v = 2000;

# t-x grid
tt = [ti for ti in T, xi in xr];
xx = [xi for ti in T, xi in xr];

# choose shot 6
is = 6

# source wavefield at z=0
source = (tt-.1).*exp.(-1e-3*(xx-xs[is]).^2 - 1e3*(tt-.1).^2);

# receiver wavefield is data for corresponding shot
receiver = Float32.(block.data[:, sx.==xs[is]]);
</code></pre>
<pre><code class="language-julia">imshow(wave_extrap(source,t,xr,v,500,1), cmap=&quot;Greys&quot;, vmin=-.001, vmax=.001, extent=[xr[1], xr[end], T[end], T[1]], aspect=500)
xlabel(&quot;x [m]&quot;)
ylabel(&quot;t [s]&quot;)
title(&quot;source wavefield at z=500 m.&quot;)

figure()
imshow(wave_extrap(receiver,t,xr,v,500,-1), cmap=&quot;Greys&quot;, vmin=-1, vmax=1, extent=[xr[1], xr[end], T[end], T[1]], aspect=500)
xlabel(&quot;x [m]&quot;)
ylabel(&quot;t [s]&quot;)
title(&quot;receiver wavefield at z=500 m.&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise3_26_0.png" /></p>
<p><img alt="png" src="../../img/Exercise3_26_1.png" /></p>
<pre><code>PyObject Text(0.5,1,'receiver wavefield at z=500 m.')
</code></pre>
<h1 id="question">Question</h1>
<ul>
<li>Extrapolate both source and receiver wavefields to differents depths. What do you notice?</li>
</ul>
<p>An image of the reflector can be constructed by correlating the two wavefields at zero time-lag (basically summing over time)</p>
<pre><code class="language-julia"># velocity
v = 2e3

# depth
dz = 10
z  = 0:dz:1000

# initialize image
image = zeros(length(z),length(xr))

# loop
for iz = 1:length(z)
    shoti       = wave_extrap(source, T, xr, v, z[iz], 1)
    reci        = wave_extrap(receiver, T, xr, v, z[iz], -1)
    image[iz,:] = sum(shoti.*reci, 1)
end

</code></pre>
<pre><code class="language-julia">figure()
imshow(image, cmap=&quot;Greys&quot;, vmin=-1e-2, vmax=1e-2, extent=[xr[1], xr[end], z[end], z[1]], aspect=1)
xlabel(&quot;x [m]&quot;)
ylabel(&quot;z [m]&quot;)
title(&quot;image for one source&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise3_30_0.png" /></p>
<pre><code>PyObject Text(0.5,1,'image for one source')
</code></pre>
<h1 id="questions_2">Questions</h1>
<ul>
<li>Use the template <code>mig_extrap</code> below and implement migration of multiple shots based on the above outlined algorithm by filling in the gaps. You can call wave_extrap as subroutine. Use mig_extrap.m for the following exercises.</li>
<li>Migrate a single shot for velocities that are too low and too high (say 10 percent). What do you see?</li>
<li>Repeat this for all sources and sum the images for all sources, again also for too low/high velocity. What do you see?</li>
<li>Describe how you would adapt the migration algorithm for a velocity that varies with depth.</li>
</ul>
<pre><code class="language-julia">function mig_extrap(data, t, xr, xs, z, v)
#
# shot-receiver migration for constant velocity by wavefield extrapolation.
#
# use:
#   image = mig_extrap(data,t,xr,xs,v)
#
# input:
#   data  - data cube of size length(t) x length(xr) x length(xs)
#   t     - time coordinate in seconds as column vector
#   xr    - receiver coordinate in meters as row vector
#   xs    - source coordinate in meters as row vector
#   z     - depth coordinate in meters as column vector
#   v     - velocity in m/s (scalar)
#
# output:
#   image - image as matrix of size length(z) x length(xr)

    # initialize image
    image = zeros(length(z),length(xr));

    # depth step
    dz = z[2] - z[1]

    # t-x grid
    tt = [ti for ti in t, xi in xr]
    xx = [xi for ti in t, xi in xr]

    # loop over shots
    for is = 1:length(xs)
        # construct impulsive source at source location
        source   = (tt-.1).*exp.(-1e-3*(xx-xs[is]).^2 - 1e3*(tt-.1).^2);

        # select data beloning to source is
        receiver =

        # loop over depth levels
        for iz = 1:length(z)
            # use wave_extrap to advance both wavefields one depthlevel
            srci    =
            reci    =

            # update image
            image[iz,:] = image[iz,:] +
        end
        # end loop over depth levels
    end
    # end loop over shots

    return image
end
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
