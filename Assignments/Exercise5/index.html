<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Exercise 5: From processing to inversion I - Imaging w/ data-driven models</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">Imaging w/ data-driven models</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../../outline/">Outline</a>
                            </li>
                            <li >
                                <a href="../../goals/">Goals</a>
                            </li>
                            <li >
                                <a href="../../reading/">Reading</a>
                            </li>
                            <li >
                                <a href="../../homework/">Assigments</a>
                            </li>
                            <li >
                                <a href="../../project/">Projects</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#exercise-5-from-processing-to-inversion-i">Exercise 5: From processing to inversion I</a></li>
        <li class="main "><a href="#contents">Contents</a></li>
            <li><a href="#linear-systems">Linear systems</a></li>
        <li class="main "><a href="#questions">Questions</a></li>
        <li class="main "><a href="#joli">JOLI</a></li>
        <li class="main "><a href="#deconvolution">Deconvolution</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="exercise-5-from-processing-to-inversion-i">Exercise 5: From processing to inversion I</h1>
<h1 id="contents">Contents</h1>
<ul>
<li>Linear systems</li>
<li>SPOT</li>
<li>Deconvolotion</li>
</ul>
<h2 id="linear-systems">Linear systems</h2>
<p>A matrix is represented in Julia as follows</p>
<pre><code class="julia">A = [1 2;3 -1]
</code></pre>

<pre><code>2×2 Array{Int64,2}:
 1   2
 3  -1
</code></pre>
<p>The transpose of a matrix is obtained via</p>
<p>A'</p>
<pre><code class="julia">A'
</code></pre>

<pre><code>2×2 Array{Int64,2}:
 1   3
 2  -1
</code></pre>
<p>In a similar manner, we can define a column vector as follows</p>
<pre><code class="julia">x = [2; 2]
</code></pre>

<pre><code>2-element Array{Int64,1}:
 2
 2
</code></pre>
<ul>
<li>Desribe two ways to define a row vector.</li>
</ul>
<p>Now, consider the matrices</p>
<pre><code class="julia">A1 = [1/sqrt(2) 2/3 sqrt(2)/6;0 1/3 -2*sqrt(2)/3;-1/sqrt(2) 2/3 sqrt(2)/6];
A2 = [0 2 2;2 1 -3;1 0 -2];
A3 = [3 1;1 0;2 1];
A4 = [2 4 3; 1 3 1];
</code></pre>

<h1 id="questions">Questions</h1>
<ul>
<li>Look at A1'*A1, what kind of matrix is A1? What does this mean?</li>
<li>Look at A2<em>[1;2;3] and A2</em>[3;1;4], what can you say about the matrix A2?</li>
<li>What do you call a linear system defined by matrix A3?</li>
<li>What do you call a linear system defined by matrix A4?</li>
</ul>
<p>If a matrix is invertible, we can explicitly find the inverse with inv</p>
<ul>
<li>find a solution of A1*x = [6;-3;0], is there only one solution? Do you really need inv here?</li>
<li>find a solution of A2*x = [4;0;-1], is there only one solution? What characterizes the solution you found?</li>
<li>find a solution of A3*x = [5;2;5], is there only one solution? What characterizes the solution you found?</li>
<li>find a solution of A4*x = [10;5], is there only one solution? What characterizes the solution you found?</li>
</ul>
<h1 id="joli">JOLI</h1>
<p>https://github.com/slimgroup/JOLI.jl</p>
<p>The JOLI toolbox gives a way to represent matrices implicitly. A nice example is the Fourier transform. In julia, the Fourier transform of a vector is given by fft(x). We can explicitly construct a matrix representing the Fourier transform as follows</p>
<pre><code class="julia"># dimension
N  = 10
F1 = zeros(Complex{Float64}, N,N)
for k = 1:N
    # construct k-th unit vector
    ek = zeros(N,1)
    ek[k] = 1

    # make column of matrix
    F1[:, k]= fft(ek)
end

</code></pre>

<ul>
<li>Look at the matrix, what do you notice?</li>
<li>Verify that it gives the same result as fft by trying on a vector</li>
</ul>
<p>We can also define the FFT using JOLI:</p>
<pre><code class="julia">using JOLI
</code></pre>

<pre><code class="julia">F2  = joDFT(N)
</code></pre>

<pre><code>JOLI.joLinearFunction{Float64,Complex{Float64}}("joDFTp", 10, 10, JOLI.#514, Nullable{Function}(JOLI.#278), Nullable{Function}(JOLI.#515), Nullable{Function}(JOLI.#279), false, Nullable{Function}(JOLI.#516), Nullable{Function}(JOLI.#280), Nullable{Function}(JOLI.#517), Nullable{Function}(JOLI.#281), false)
</code></pre>
<pre><code class="julia">whos(r&quot;F1&quot;), whos(r&quot;F2&quot;);
</code></pre>

<pre><code>                            F1   1600 bytes  10×10 Array{Complex{Float64},2}
                            F2    582 bytes  JOLI.joLinearFunction{Float64,Comp…
</code></pre>
<p>And this is only a small example! The reason why we want to have such operations behave like matrices is that we can use (some) standard algorithms that where written to work with matrices to work with large scale operations. As an example we use a Gaussian matrix:</p>
<pre><code class="julia">N  = 10000;
# NxN Gaussian matrix
G1 = ones(N, N);
</code></pre>

<pre><code class="julia"># NxN Gaussian JOLI operator (will represent a different matrix than G1 becuase it is gerenated randomly)
G2 = joOnes(N);
</code></pre>

<pre><code class="julia">whos(r&quot;G1&quot;), whos(r&quot;G2&quot;);
</code></pre>

<pre><code>                            G1 781250 KB     10000×10000 Array{Float64,2}
                            G2    246 bytes  JOLI.joMatrix{Float64,Float64}
</code></pre>
<h1 id="deconvolution">Deconvolution</h1>
<p>We some signal $f(t)$ which is a convolution of some unkown signal $g(t)$ and a known filter $w(t)$. Given $f$ and $w$ we would like to retreive $g$.</p>
<p>For the example we use:</p>
<pre><code class="julia"># time axis
t = 0:.001:2';
N = length(t);

# true signal g has approx k spikes with random amplitudes
k = 20;
g = zeros(N,1);
g[rand(1:N, k)] = randn(k,1);

# filter
w = (1-2*1e3*(t-.2).^2).*exp.(-1e3*(t-.2).^2);

# plot
using PyPlot
figure();
plot(t,g);
xlabel(&quot;t [s]&quot;);ylabel(&quot;g(t)&quot;);

figure();
plot(t,w);
xlabel(&quot;t [s]&quot;);ylabel(&quot;w(t)&quot;);
</code></pre>

<p><img alt="png" src="../../img/Exercise5_24_0.png" /></p>
<p><img alt="png" src="../../img/Exercise5_24_1.png" /></p>
<p>First, we consider the <code>forward</code> problem of convolving a signal, using JOLI.</p>
<p>Perform the convolution using the usual julia commands fft, ifft and element-wise multiplication .*.
Creat a JOLI operator to do the same. You can construct an operator to do the multiplication with the filter using joDiag.
 - Compare the results of both.
 - Compare f to g, what do you notice?
 - Assuming that your convolution operator is called C:</p>
<p>Now, construct the signal f using your SPOT operator and add some noise (i.e., f = C<em>g + 1e-1</em>randn(N,1)).
Do you think C has a null-space? If so, describe it. (Hint: look at the filter).
Use the adjoint of C as an approximation to the inverse, what does this correspond to and what does the reconstruction look like?
 - Describe how you would invert the system.
 - Use lsqr to do it. (you might need to increase the number of iterations.)
 - Look at the signal that is predicted by your reconstruction, do you see a difference with the true signal?</p>
<p>lsqr will give us a solution that has a small two-norm and explains the data. Alternatively, we can use another solver that will give us a spiky solution and explains the data. This solver is spgl1. Try spgl1(C,f,0,1e-2).</p>
<p>https://github.com/slimgroup/GenSPGL.jl</p>
<ul>
<li>Is this solution closer to the true one?</li>
<li>Look at the predicted signal for this solution, do you see a difference with the true signal? Can we really say that this is a better solution?</li>
</ul>
<pre><code class="julia">using GenSPGL
# Pkg.clone(&quot;https://github.com/slimgroup/GenSPGL.jl&quot;)
</code></pre>

<pre><code class="julia"># FFT convolution
wf = fft(w);
f1 = ifft(wf.*fft(g));
</code></pre>

<pre><code class="julia"># JOLI operator to perform convolution.
C = joDFT(N)'*joDiag(wf)*joDFT(N);
f2 = C*g;

figure();
plot(t,f1)
plot(t,f2)
plot(t,g);
xlabel(&quot;t [s]&quot;);ylabel(&quot;f(t)&quot;);legend([&quot;normal&quot;,&quot;JOLI&quot;, &quot;g&quot;]);
</code></pre>

<p><img alt="png" src="../../img/Exercise5_28_0.png" /></p>
<pre><code class="julia"># true signal
f = C*g + 1e-3*randn(N,1);

# lsqr
gt = C\f

</code></pre>

<pre><code>2001×1 Array{Float64,2}:
 0.00666159
 0.00698098
 0.00728673
 0.00760021
 0.00786498
 0.00796295
 0.00801857
 0.00814685
 0.00807513
 0.0079503
 0.00779799
 0.00749169
 0.00719726
 ⋮         
 0.00508929
 0.00474104
 0.00452079
 0.00435027
 0.00431479
 0.00439437
 0.00467603
 0.00483907
 0.00517327
 0.00548942
 0.00585045
 0.00628071
</code></pre>
<pre><code class="julia"># Solve
opts = spgOptions(optTol = 1e-10,
                  verbosity = 1)

#gtt, r, grads, info = spgl1(C, vec(f), tau = 0., sigma = norm(f - C*gt))
</code></pre>

<pre><code>GenSPGL.spgOptions(1, 1, 100000, 3, 1.0e-6, 1.0e-6, 1.0e-10, 0.0001, 1.0e-16, 100000.0, 2, Inf, false, Nullable{Bool}(), Inf, [1], false, 3, 1, 10000, false, GenSPGL.NormL1_project, GenSPGL.NormL1_primal, GenSPGL.NormL1_dual, GenSPGL.funLS, false, false, false)
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
