<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>NMO correction - Imaging w/ data-driven models</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Imaging w/ data-driven models</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../outline/" class="nav-link">Topics</a>
                            </li>
                            <li class="navitem">
                                <a href="../../homework/" class="nav-link">Assigments</a>
                            </li>
                            <li class="navitem">
                                <a href="../../project/" class="nav-link">Projects</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#nmo-correction" class="nav-link">NMO correction</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#pick-a-midpoint" class="nav-link">Pick a midpoint</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#constant-velocity-nmo-correction" class="nav-link">Constant velocity NMO correction</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#windowing" class="nav-link">Windowing</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#stack-power" class="nav-link">Stack power</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#look-at-the-velocity-profile-with-the-picked-tauv-pairs" class="nav-link">Look at the velocity profile with the picked tau/v pairs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#velocity-analysis" class="nav-link">Velocity analysis</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="nmo-correction">NMO correction</h1>
<p>The traveltime as a function of offset of a reflected event can be approximated by the NMO traveltime:</p>
<p>$
\tau(t_0,h) = \sqrt{t_0 + h<sup>2/v</sup>2}
$</p>
<p>where <span class="arithmatex">\((t_0)\)</span> is the zero-offset or vertical traveltime and <span class="arithmatex">\(v\)</span> is the effective or NMO velocity.</p>
<p>We can now correct the data for the moveout via a simple coordinate transform:</p>
<p>$
d_{NMO}(t_0,h) = d(\tau(t_0,h),h)
$</p>
<p>You can use the function <code>nmo</code> implemented below for this exercise.</p>
<pre><code class="language-julia">using Dierckx
function nmo(cmp, t, off, v)
# NMO correction and adjoint
#
# use:
#   out = nmo(in,t,h,v,flag)
#
# input:
#   in   - data matrix of size [length(t) x length(h)], each column is a trace
#   t    - time vector [s]
#   offsets    - offset vector [m]
#   v    - NMO velocity [m/s] as vector of size [length(t) x 1].
#   flag - 1:forward, -1:adjoint
#
# output
#   out  - data matrix of size [length(t) x length(h)], each column is a trace

    # size of data
    nt, nh = size(cmp)
    # make sure t and v are column vectors
    t = t[:]
    v = v[:]
    # initialize output
    out = zeros(nt, nh)
    # loop over offset
    for i = 1:nh
        # NMO traveltime
        tau = sqrt.(t.^2 + off[i].^2./v.^2);
        # interpolate, forward or adjoint
        spl = Spline1D(t, cmp[1e-3*T.-t.&lt;1e-5, i])
        out[:,i] = spl(tau)
    end
    return out
end
</code></pre>
<pre><code>nmo (generic function with 1 method)
</code></pre>
<pre><code class="language-julia">using SeisIO, PyPlot
</code></pre>
<pre><code class="language-julia"># read the dataset

blocks = segy_read(&quot;/data/mlouboutin3/Class_data/cube2.segy&quot;);
</code></pre>
<pre><code class="language-julia">sx = get_header(blocks, &quot;SourceX&quot;;scale=false)
rx = get_header(blocks, &quot;GroupX&quot;;scale=false);

</code></pre>
<pre><code class="language-julia"># Get the time axis. In this case the time axis is the same for all traces so we only need to extract it from the first trace
# dt needs to be corrected for the binary setup
# All the times are in ms
dt = get_header(blocks, &quot;dt&quot;)[1]/1000
nt = get_header(blocks, &quot;ns&quot;)[1]
T = 0:dt:(nt-1)*dt
</code></pre>
<pre><code>0.0:4.0:2000.0
</code></pre>
<pre><code class="language-julia"># Midpoint and offset
h = (sx .- rx);
m = (sx .+ rx)./2;
</code></pre>
<pre><code class="language-julia">all_m = hcat(m'...)'
fold = [sum(all_m .== unique(all_m)[i]) for i=1:length(unique(all_m))];

all_h = hcat(h'...)';
</code></pre>
<h1 id="pick-a-midpoint">Pick a midpoint</h1>
<pre><code class="language-julia">Im = find(all_m .== all_m[1000])
offsets = sort((all_h[Im]));
inds = sortperm(all_h[Im])
cmp = Float32.(blocks.data[:, Im[inds]]);
</code></pre>
<pre><code class="language-julia">figure()
imshow(cmp, vmin=-1, vmax=1, cmap=&quot;Greys&quot;, aspect=3, extent=[offsets[1], offsets[end], T[end], 0])
xlabel(&quot;offset&quot;)
ylabel(&quot;time&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise2_10_0.png" /></p>
<pre><code>PyObject Text(24,0.5,'time')
</code></pre>
<h1 id="constant-velocity-nmo-correction">Constant velocity NMO correction</h1>
<pre><code class="language-julia">nmo_corrected1 = nmo(cmp, 1e-3.*T, offsets, 2000. + 0.*T);
</code></pre>
<pre><code class="language-julia">figure()
imshow(nmo_corrected1, vmin=-1, vmax=1, cmap=&quot;Greys&quot;, aspect=3, extent=[offsets[1], offsets[end], T[end], 0])
xlabel(&quot;offset&quot;)
ylabel(&quot;time&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise2_13_0.png" /></p>
<pre><code>PyObject Text(24,0.5,'time')
</code></pre>
<h1 id="windowing">Windowing</h1>
<p>We can see a lot of `artifacts' in the NMO corrected gather above. To avoid some of the artifacts, the midpoint gathers are often windowed to select reflected data only. All events that arrive before the direct wave are removed. A typical window looks like this (Hint: the slope of the triangle is related to the veloctity of the direct wave).</p>
<pre><code class="language-julia"># grid
tt = [1e-3*ti for ti in T for h in offsets]
hh = [h for ti in T for h in offsets]

# initialize window to zero and set times later than first arrival to 1.
W=0.*tt;W[tt.&gt;(.1+ abs.(hh)./1500)] = 1
W = reshape(W, size(cmp)[2], size(cmp)[1])
imshow(W', vmin=0, vmax=1, cmap=&quot;jet&quot;, aspect=3, extent=[offsets[1], offsets[end], T[end], 0])
xlabel(&quot;offset&quot;)
ylabel(&quot;time&quot;)

</code></pre>
<p><img alt="png" src="../../img/Exercise2_15_0.png" /></p>
<pre><code>PyObject Text(24,0.5,'time')
</code></pre>
<pre><code class="language-julia">muted = W'.*cmp;
</code></pre>
<pre><code class="language-julia">figure()
imshow(muted, vmin=-1e0, vmax=1e0, cmap=&quot;Greys&quot;, aspect=3, extent=[offsets[1], offsets[end], T[end], 0])
xlabel(&quot;offset&quot;)
ylabel(&quot;time&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise2_17_0.png" /></p>
<pre><code>PyObject Text(24,0.5,'time')
</code></pre>
<h1 id="stack-power">Stack power</h1>
<p>To figure out which NMO velocity optimally flattens all the events, we can scan through a range of constant NMO velocities and see which events are flattened for which velocity. One way to judge flatness of an event is via the stackpower. The stackpower is just a sum along the offset direction of the values-squared of the NMO-corrected gather:</p>
<p>$ S(t_0,v) = \int!!\mathrm{d}h\, d(\tau(t_0,h,v),h)^2 $</p>
<p>The function $ S(t_0,v) $ is called a semblance panel.</p>
<p>The desired NMO velocity can be found by picking the maximum as a function of <span class="arithmatex">\(t_0\)</span> and <span class="arithmatex">\(v\)</span> from the semblance panel.</p>
<p>An example of a semblance panel and the resulting NMO velocity is shown below.</p>
<pre><code class="language-julia">v = linspace(1000, 3000, 500)
# scan over velocities
S = zeros(length(T),length(v));
for k = 1:length(v)
    cmp_nmo = nmo(muted, 1e-3.*T, offsets, v[k] .+ 0.*T);
    S[:,k]  = sum(cmp_nmo.^2,2);
end
</code></pre>
<pre><code class="language-julia">#Plot semblance panel
figure()
imshow(S, vmin=0, vmax=1e3, cmap=&quot;jet&quot;, aspect=1, extent=[v[1], v[end], T[end], 0])
xlabel(&quot;velocity&quot;)
ylabel(&quot;tau&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise2_20_0.png" /></p>
<pre><code>PyObject Text(24,0.5,'tau')
</code></pre>
<pre><code class="language-julia">#  pick v/tau pairs
</code></pre>
<pre><code class="language-julia">tv   = 1e3*[0,    0.30, 0.35, 0.46, 0.65, 1.27, 2.00];
vnmo =     [1500, 1500, 1600, 1700, 2000, 2179, 3000];
spl = Spline1D(tv, vnmo; k=1)
vnmo_all = spl(T);
</code></pre>
<h1 id="look-at-the-velocity-profile-with-the-picked-tauv-pairs">Look at the velocity profile with the picked tau/v pairs</h1>
<pre><code class="language-julia"># Enable gui to have the cursor and pick v/tau pairs
figure()
imshow(S, vmin=0, vmax=1e3, cmap=&quot;jet&quot;, aspect=1, extent=[v[1], v[end], T[end], 0])
plot(vnmo_all, T, &quot;-k&quot;)
xlabel(&quot;velocity&quot;)
ylabel(&quot;tau&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise2_24_0.png" /></p>
<pre><code>PyObject Text(24,0.5,'tau')
</code></pre>
<pre><code class="language-julia">nmo_corrected = nmo(muted, 1e-3.*T, offsets, vnmo_all) ;
</code></pre>
<pre><code class="language-julia">figure()
imshow(nmo_corrected, vmin=-1e0, vmax=1e0, cmap=&quot;Greys&quot;, aspect=3, extent=[offsets[1], offsets[end], T[end], 0])
xlabel(&quot;offset&quot;)
ylabel(&quot;time&quot;)
</code></pre>
<p><img alt="png" src="../../img/Exercise2_26_0.png" /></p>
<pre><code>PyObject Text(24,0.5,'time')
</code></pre>
<h1 id="velocity-analysis">Velocity analysis</h1>
<p>Repeat the above outline procedure for a couple of mipdoint positions xm (e.g., <code>xm = [500 1000 2000]</code>). Organize the resulting NMO velocities in a matrix <code>Vm</code> (where column i is the NMO velocity for midpoint <code>xm[i]</code>) interpolate the results to obtain a velocity for all the midpoints using <code>Spline1D(xm, VM); spl(all_m)</code>. Plot the velocity and discuss.</p>
<p>Using this NMO velocity, we can produce an NMO stack. Perform an NMO correction of all the midpoint gathers using the corresponding NMO velocity derived above and sum each along the offset direction. Organize all the stacks in a matrix and plot the result. Also make a stack using a constant NMO velocity. Discuss the results.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../javascripts/mathjax.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
